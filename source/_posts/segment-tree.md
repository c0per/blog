---
title: çº¿æ®µæ ‘å°ç»“
date: 2020-07-29 17:00:00
tags:
- çº¿æ®µæ ‘
categories:
- æ•°æ®ç»“æ„
- çº¿æ®µæ ‘
---

# çº¿æ®µæ ‘å°ç»“

æ•´ç†å½’çº³ä¸€ä¸‹ OI ç«èµ›ä¸­çš„çº¿æ®µæ ‘è€ƒæ³•ï¼ŒæŒç»­æ›´æ–°ã€‚

<!-- more -->

## æ™®é€šçš„çº¿æ®µæ ‘

ä¸€èˆ¬æ¥è¯´ï¼Œä»–åªæ”¯æŒå•ç‚¹ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ã€‚

```c++
struct set_t {
    int c[maxn << 2];
    void push_up(int k) {
        c[k] = c[k << 1] + c[k << 1 | 1];
    }
    void init(int k, int l, int r) {
        if (l == r) {
            c[l] = a[l];
            return;
        }
        int mid = (l + r) >> 1;
        init(k << 1, l, mid);
        init(k << 1 | 1, mid + 1, r);
        push_up(k);
    }
    int query(int k, int l, int r, int L, int R) {
        if (L <= l && r <= R)
            return c[k];
        int mid = (l + r) >> 1;
        int re = 0;
        if (L <= mid) re += query(k << 1, l, mid, L, R);
        if (R > mid) re += query(k << 1 | 1, mid + 1, r, L, R);
        return re;
    }
    void mod(int k, int l, int r, int pos, int x) {
        if (l == r) {
            c[k] += x;
            return;
        }
        int mid = (l + r) >> 1;
        if (pos <= mid) mod(k << 1, l, mid, pos, x);
        else mod(k << 1 | 1, mid + 1, r, pos, x);
        push_up(k);
    }
}t;
```

ä¹‹æ‰€ä»¥ä¸æ”¯æŒåŒºé—´ä¿®æ”¹ï¼Œæ˜¯å› ä¸ºæ¯æ¬¡ä¿®æ”¹å¿…é¡»è¦è®¿é—®åˆ°å¶å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¼šæœ‰$O(nlog_{2}n)$çš„å¤æ‚åº¦ã€‚

### ç»ƒä¹ é¢˜

[Luogu P4588 [TJOI2018]æ•°å­¦è®¡ç®—](https://www.luogu.com.cn/problem/P4588)

## Lazy Tag çº¿æ®µæ ‘

è¿™ä¸ªæ‰æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„çº¿æ®µæ ‘ã€‚

ä»–æ”¯æŒåŒºé—´ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ã€‚

```c++
struct set_t {
    int c[maxn << 2], tag[maxn << 2];
    void push_up(int k) {
        c[k] = c[k << 1] + c[k << 1 | 1];
    }
    void push_down(int k, int l, int r) {
        int mid = (l + r) >> 1;
        tag[k << 1] += tag[k];
        tag[k << 1 | 1] += tag[k];
        c[k << 1] += tag[k] * (mid - l + 1);
        c[k << 1 | 1] += tag[k] * (r - mid);
        tag[k] = 0;
    }
    void init(int k, int l, int r) {
        if (l == r) {
            c[l] = a[l];
            return;
        }
        int mid = (l + r) >> 1;
        init(k << 1, l, mid);
        init(k << 1 | 1, mid + 1, r);
        push_up(k);
    }
    int query(int k, int l, int r, int L, int R) {
        if (L <= l && r <= R)
            return c[k];
        push_down(k, l, r);
        int mid = (l + r) >> 1;
        int re = 0;
        if (L <= mid) re += query(k << 1, l, mid, L, R);
        if (R > mid) re += query(k << 1 | 1, mid + 1, r, L, R);
        return re;
    }
    void mod(int k, int l, int r, int pos, int x) {
        if (l == r) {
            c[k] += x;
            return;
        }
        push_down(k, l, r);
        int mid = (l + r) >> 1;
        if (pos <= mid) mod(k << 1, l, mid, pos, x);
        else mod(k << 1 | 1, mid + 1, r, pos, x);
        push_up(k);
    }
    void add(int k, int l, int r, int L, int R, int x) {
        if (L <= l && r <= R) {
            c[k] += (r - l + 1) * x;
            tag[k] += x;
            return;
        }
        push_down(k, l, r);
        int mid = (l + r) >> 1;
        if (L <= mid) add(k << 1, l, mid, L, R, x);
        if (R > mid) add(k << 1 | 1, mid + 1, r, L, R, x);
        push_up(k);
    }
}t;
```

ä¹‹æ‰€ä»¥ç§°ä¸º Lazy çš„ Tagï¼Œæ˜¯å› ä¸ºåªæœ‰å½“éœ€è¦è®¿é—®å„¿å­èŠ‚ç‚¹æ—¶ï¼Œæ‰ä¼šå°†æœ¬èŠ‚ç‚¹çš„æ ‡è®°ä¸‹æ”¾ï¼ˆ`push_down()`ï¼‰ã€‚

å¯¹äºä¸€ä¸ªåŒºé—´æ“ä½œï¼Œåªæœ‰åŒºé—´ä¸¤è¾¹çš„å¶å­èŠ‚ç‚¹æ‰æœ‰è¢«è®¿é—®çš„å¯èƒ½ï¼Œå…¶ä»–ä¸­é—´çš„èŠ‚ç‚¹ Tag æ ‡è®°åå°±ä¸å†ç»§ç»­å¾€ä¸‹ã€‚

è¿™æ ·ï¼Œä¿è¯æ¯æ¬¡ä¿®æ”¹ã€æŸ¥è¯¢çš„å¤æ‚åº¦ä¸º$log_{2}n$ã€‚

ä»£ç ä¸­éœ€è¦æ³¨æ„åŠæ—¶`push_down()`å’Œ`push_up()`ã€‚

### ç»ƒä¹ é¢˜

[Luogu P3372 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 1](https://www.luogu.com.cn/problem/P3372)

[Luogu P4198 æ¥¼æˆ¿é‡å»º](https://www.luogu.com.cn/problem/P4198)

## å¤šä¸ª Tag çš„çº¿æ®µæ ‘

æ™®é€šçš„åŠ å‡ä¹˜é™¤å’Œå–æ¨¡è¿ç®—éƒ½å¯ä»¥ä½¿ç”¨ Lazy Tag çº¿æ®µæ ‘ç»´æŠ¤ã€‚

ä½†å¦‚æœéœ€è¦åŒæ—¶æ”¯æŒå¤šç§æ“ä½œï¼Œåˆ™éœ€è¦å¤šä¸ª Tagã€‚

éœ€è¦æ³¨æ„çš„è¦ç‚¹æ˜¯ï¼Œä½ éœ€è¦å®šä¹‰ Tag çš„ä¼˜å…ˆçº§ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ£µåŒæ—¶æ”¯æŒåŒºé—´åŠ æ³•å’Œä¹˜æ³•çš„çº¿æ®µæ ‘ï¼š

å®šä¹‰ Tagp ä¸ºåŠ æ³• Tagï¼ŒTagm ä¸ºä¹˜æ³• Tagã€‚

- åŠ æ³•ä¼˜å…ˆ

`x = (x + tagp[x]) * tagm[x];`

å…ˆåŠ $A$ï¼Œå†ä¹˜$B$ã€‚

```c++
tagp[x] = A;
tagm[x] = B;
```

å…ˆä¹˜$A$ï¼Œå†åŠ $B$ã€‚

```c++
tagm[x] = A;
push_down();
tagp[x] = B;
```

- ä¹˜æ³•ä¼˜å…ˆ

`x = (x * tagm[x]) + tagp[x];`

å…ˆåŠ $A$ï¼Œå†ä¹˜$B$ã€‚

```c++
tagp[x] = A;
push_down();
tagm[x] = B;
```

å…ˆä¹˜$A$ï¼Œå†åŠ $B$ã€‚

```c++
tagm[x] = A;
tagp[x] = B;
```

### ç»ƒä¹ é¢˜

[P3373 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 2](https://www.luogu.com.cn/problem/P3373)

## ç»´æŠ¤åŒºé—´å¼€æ–¹æ“ä½œ

å¯¹äºæ”¯æŒåŒºé—´å¼€æ–¹å’ŒåŒºé—´æ±‚å’Œçš„çº¿æ®µæ ‘ï¼Œæˆ‘ä»¬æ€ä¹ˆåšå‘¢ï¼ŸğŸ¤”

ç»è¿‡æ€è€ƒï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å³ä½¿æ˜¯å¾ˆå¤§çš„æ•°ï¼Œå†ç»è¿‡å¾ˆå°‘æ¬¡æ•°çš„å¼€æ–¹æ“ä½œåï¼Œå°±èƒ½å˜æˆ 1ã€‚

ä¾‹å¦‚ï¼š$10^{18}$åœ¨ç»è¿‡ 6 æ¬¡å¼€æ–¹å¹¶å‘ä¸‹å–æ•´çš„æ“ä½œåï¼Œå°±å˜æˆ 1 äº†ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è®°å½•å½“å‰åŒºé—´çš„æœ€å¤§å€¼ï¼Œå¦‚æœæ­¤å€¼ä¸º 1 ï¼Œå°±æ— éœ€å†è¿›è¡Œæ“ä½œã€‚

å¦åˆ™ï¼Œæˆ‘ä»¬è¿›å…¥å­èŠ‚ç‚¹è¿›è¡Œä¿®æ”¹ï¼ˆä¸€è·¯åˆ°è¾¾å¶å­èŠ‚ç‚¹ï¼‰ã€‚

å¬ç€æ¯”è¾ƒæš´åŠ›ï¼Œä½†æ˜¯æ—¶é—´å¤æ‚åº¦æ˜¯å®Œå…¨å¯æ¥å—çš„ã€‚

å½“ç„¶ï¼Œå¦‚æœæŠŠå¼€æ–¹å’Œå…¶ä»–æ“ä½œï¼ˆå¦‚åŠ æ³•ï¼‰ç»“åˆåœ¨ä¸€èµ·ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

```c++
void modify(int k, int l, int r, int L, int R) {
    if (L <= l && r <= R && mx[k] == 1) {
        return;
    if (l == r) {
        mx[k] = sqrt(c[k]);
        return;
    }
    push_down(k, l, r);
    int mid = (l + r) >> 1;
    if (L <= mid) modify(k << 1, l, mid, L, R);
    if (R > mid) modify(k << 1 | 1, mid + 1, r, L, R);
    push_up(k);
}
```

### ç»ƒä¹ é¢˜

[Luogu P4145 ä¸Šå¸é€ é¢˜çš„ä¸ƒåˆ†é’Ÿ2 / èŠ±ç¥æ¸¸å†å„å›½](https://www.luogu.com.cn/problem/P4145)

[UOJ #228. åŸºç¡€æ•°æ®ç»“æ„ç»ƒä¹ é¢˜](http://uoj.ac/problem/228)

## çº¿æ®µæ ‘åŒºé—´å– Min/Max

è¿™é‡Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ç§æ“ä½œï¼šå¯¹äºä¸€ä¸ªåŒºé—´$[l, r]$å’Œä¸€ä¸ªæ•°$x$ï¼Œæˆ‘ä»¬å°†å…¶ä¸­æ¯ä¸€ä¸ªæ•°$a[i]$ä¿®æ”¹ä¸º$min/max(a[i], x)$ã€‚

1. æ•°æ®æ»¡è¶³å•è°ƒæ€§

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨äºŒåˆ†æ±‚å‡ºéœ€è¦ä¿®æ”¹çš„åŒºé—´ï¼Œå†è¿›è¡ŒåŒºé—´ä¿®æ”¹å³å¯ã€‚

2. æ•°æ®æ— ç‰¹æ®Šæ€§ï¼Œæ”¯æŒåŒºé—´åŠ æ³•å’ŒåŒºé—´æ±‚æå€¼ã€‚

æˆ‘ä»¬è®°å½•ä¸¤ä¸ª Tagï¼Œ`add[x]`ä¸ºèŠ‚ç‚¹ x ä¸Šå¢åŠ çš„å€¼ï¼Œ`mx[x]`ä¸ºèŠ‚ç‚¹ x ä¸Šé€šè¿‡å– Max å¾—åˆ°çš„å€¼ã€‚

æˆ‘ä»¬ä»¤`add`æ ‡ç­¾çš„ä¼˜å…ˆçº§æ›´é«˜ã€‚

é‚£ä¹ˆ$x$çš„çœŸå®å€¼ä¸º`max(x + add[x], mx[x])`ã€‚

åŒºé—´åŠ $A$ï¼šmax(x + add[x] + A, mx[x] + A)ï¼Œæ›´æ–°`add[x]`å’Œ`mx[x]`æ ‡ç­¾ã€‚

åŒºé—´å– Max $A$ï¼šmax(x + add[x], max(mx[x], A))ï¼Œæ›´æ–°`mx[x]`æ ‡ç­¾ã€‚

## æ±‚åŒºé—´$Mex$å€¼

æ‰€è°“$Mex$å®šä¹‰ä¸ºåŒºé—´ä¸­æ²¡æœ‰å‡ºç°è¿‡çš„æœ€å°éè´Ÿæ•´æ•°ã€‚

ä¸éœ€è¦æ”¯æŒä¿®æ”¹ï¼Œæˆ‘ä»¬è€ƒè™‘ç¦»çº¿ç®—æ³•ï¼Œå¯¹æ‰€æœ‰çš„è¯¢é—®æ’åºåå¤„ç†ã€‚

å‡è®¾å¯¹äºæ‰€æœ‰ä»¥$l$ä¸ºå·¦ç«¯ç‚¹çš„è¯¢é—®ï¼Œæˆ‘ä»¬è®¾$mex[i]$ä¸º$[l, i]$åŒºé—´çš„$Mex$å€¼ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨$O(n)$æ—¶é—´å†…é€šè¿‡ä¸€ä¸ªæ¡¶å¾—å‡º$mex[]$ã€‚

å¯¹äºä»¥$l + 1$ä¸ºå·¦ç«¯ç‚¹çš„è¯¢é—®ï¼Œæˆ‘ä»¬è€ƒè™‘åˆ é™¤$a[l]$å¯¹$mex[]$çš„å½±å“ã€‚

è®¾$x = a[l]ä¸‹ä¸€æ¬¡å‡ºç°çš„ä½ç½®$ï¼Œé‚£ä¹ˆå¯¹äº$mex[i >= x]$æ˜¯ä¸ä¼šæœ‰å½±å“çš„ã€‚

å¯¹äº$mex[i < x]$ï¼Œå¦‚æœ$mex[i] > a[l]$ï¼Œæˆ‘ä»¬å°†$mex[i]$è®¾ä¸º$a[l]$ï¼Œå³å¯ä»$l$è½¬ç§»åˆ°$l + 1$ã€‚

å¦å¤–ï¼Œç”±äº$mex[]$æ˜¯éé™çš„ï¼Œæˆ‘ä»¬å¾ˆç®€å•åœ°å®Œæˆè¿™ä¸ªå– min æ“ä½œã€‚

æ˜æ˜¾å¯ä»¥ä½¿ç”¨çº¿æ®µæ ‘åœ¨$log_{2}n$å†…å®Œæˆã€‚

### ç»ƒä¹ é¢˜

[Luogu P4137 Rmq Problem / mex](https://www.luogu.com.cn/problem/P4137)

## æœ€å¤§å­æ®µå’Œ

æ”¯æŒæŸ¥è¯¢$[l, r]$åŒºé—´å†…æœ€å¤§çš„è¿ç»­å­æ®µçš„å’Œã€‚

æˆ‘ä»¬è€ƒè™‘æœ€å¤§å­æ®µåœ¨å½“å‰èŠ‚ç‚¹ä¸­çš„åˆ†å¸ƒ:

- æœ€å¤§å­æ®µåœ¨å·¦/å³å„¿å­èŠ‚ç‚¹ä¸­

æˆ‘ä»¬ç›´æ¥å–æœ€å¤§å€¼å³å¯å¾—å‡ºã€‚

- æœ€å¤§å­æ®µç»è¿‡äº†ä¸­ç‚¹ï¼Œéœ€è¦åˆå¹¶å·¦å³å„¿å­èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚

æˆ‘ä»¬è®°å½•$res$ä¸ºå½“å‰èŠ‚ç‚¹çš„æœ€å¤§å­æ®µå’Œï¼Œ$sum$ä¸ºåŒºé—´å’Œï¼Œ$prel$ä¸ºä»æœ€å·¦ç«¯å¼€å§‹çš„æœ€å¤§å­æ®µå’Œï¼Œ$prer$ä¸ºä»¥å³ç«¯ä¸ºç»“å°¾çš„æœ€å¤§å­æ®µå’Œã€‚

åˆå¹¶å­èŠ‚ç‚¹ä¿¡æ¯æ—¶ï¼š

```c++
res[rt] = std::max(std::max(res[l], res[r]), prer[l] + prel[r])
sum[rt] = sum[l] + sum[r];
prel[rt] = std::max(prel[l], sum[l] + prel[r]);
prer[rt] = std::max(prer[r], sum[r] + prer[l]);
```

### ç»ƒä¹ é¢˜

[Luogu SP1716 GSS3 - Can you answer these queries III](https://www.luogu.com.cn/problem/SP1716)

[Luogu P3582 [POI2015]KIN](https://www.luogu.com.cn/problem/P3582)

## å‚¨å­˜ã€Œä¸Šä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼ˆå‰é©±ï¼‰ã€

å¯¹äºæ•°ç»„`a[]`ï¼Œæˆ‘ä»¬æ„é€ æ•°ç»„`b[]`ï¼Œä½¿å¾—`b[i] =`å€¼ä¸º`a[i]`çš„æ•°åœ¨`a`æ•°ç»„ä¸­ä¸Šä¸€æ¬¡å‡ºç°çš„ä¸‹æ ‡ã€‚

å¦‚ä½•æ„é€ `b[]`ï¼Ÿ

- ç”¨`std::map`

- ç¦»æ•£åŒ– + æ¡¶

å¦‚æœæˆ‘ä»¬ç»´æŠ¤å½“å‰èŠ‚ç‚¹å†…çš„å‰é©±æœ€å¤§å€¼ï¼Œé€šè¿‡å’Œå½“å‰èŠ‚ç‚¹çš„å·¦è¾¹ç•Œåšæ¯”è¾ƒï¼Œå³å¯å¾—çŸ¥æ­¤åŒºé—´å†…æ˜¯å¦æœ‰é‡å¤çš„æ•°ã€‚

### ç»ƒä¹ é¢˜

[Luogu P1972 [SDOI2009]HHçš„é¡¹é“¾](https://www.luogu.com.cn/problem/P1972)

## ç»´æŠ¤åŒºé—´$gcd$

é‡ç‚¹åœ¨äºèŠ‚ç‚¹çš„åˆå¹¶ã€‚

ç»†ç»†æ€è€ƒä¸€ä¸‹ï¼Œå½“å‰èŠ‚ç‚¹çš„$gcd$å€¼ï¼Œåº”è¯¥ç­‰äº$gcd(tr[l].gcd, tr[r].gcd)$ã€‚

### ç»ƒä¹ é¢˜

[Luogu P5278 ç®—æœ¯å¤©æ‰â‘¨ä¸ç­‰å·®æ•°åˆ—](https://www.luogu.com.cn/problem/P5278)

## å°†æ–œç‡å‚¨å­˜åœ¨çº¿æ®µæ ‘ä¸­

ç¬”è€…è®°å¾—æœ‰è¿™æ ·ä¸€é“é¢˜ï¼ˆå®åœ¨æ˜¯æ‰¾ä¸åˆ°åŸé¢˜äº†QAQï¼‰

ç»™å‡ºåœ¨ä¸€ä¸ªäºŒç»´å¹³é¢å†…çš„è‹¥å¹²çŸ©å½¢çš„åæ ‡ï¼Œï¼ˆå¤šç»„ï¼‰è¯¢é—®å¦‚æœä»ç‚¹$(0, 0)$å‘å‡ºä¸€æ¡ä»¥$k$ä¸ºæ–œç‡çš„å…‰çº¿ï¼Œæ˜¯å¦ä¼šæ¥è§¦åˆ°çŸ©å½¢ã€‚

æ”¯æŒåŠ¨æ€å¢åŠ ã€åˆ é™¤çŸ©å½¢ï¼Œä¸å¼ºåˆ¶åœ¨çº¿ã€‚

å¦‚æœå¯¹äºæ¯ç»„è¯¢é—®ï¼Œæˆ‘ä»¬éå†æ¯ä¸€ä¸ªçŸ©å½¢åˆ¤æ–­æ˜¯å¦æ¥è§¦ï¼Œæ˜¾ç„¶æ˜¯ä¼šè¶…æ—¶çš„ã€‚

å¦‚ä½•ä½¿ç”¨çº¿æ®µæ ‘æ±‚è§£å‘¢ï¼Ÿ

å¯¹äºæ¯ä¸€ä¸ªçŸ©å½¢ï¼Œæˆ‘ä»¬æ±‚å‡ºå…¶ä»¥$(0, 0)$ä¸ºèµ·ç‚¹çš„ç›´çº¿ä¸å…¶æ¥è§¦çš„æ–œç‡èŒƒå›´$[l, r]$ã€‚

å°†æ‰€æœ‰çš„æ–œç‡èŒƒå›´ç«¯ç‚¹å’ŒæŸ¥è¯¢æ˜¯ç»™å‡ºçš„æ–œç‡ç¦»æ•£åŒ–åï¼Œåœ¨çº¿æ®µæ ‘ä¸­æ‰“ä¸Šæ ‡è®°ã€‚

æŸ¥è¯¢æ—¶å•ç‚¹æŸ¥æ‰¾æ˜¯å¦æœ‰æ ‡è®°è¦†ç›–å³å¯ã€‚

é€šè¿‡å°†æ–œç‡ç¦»æ•£åŒ–åå‚¨å­˜åœ¨çº¿æ®µæ ‘ä¸­ï¼Œæˆ‘ä»¬å°†è¿™é“é¢˜è½¬åŒ–ä¸ºåŒºé—´ä¿®æ”¹ã€å•ç‚¹æŸ¥è¯¢çš„é¢˜ã€‚

## æƒå€¼çº¿æ®µæ ‘

å…¶å®å°±æ˜¯ä¸€æ£µæ™®é€šçš„çº¿æ®µæ ‘ï¼Œåªä¸è¿‡æˆ‘ä»¬ç»´æŠ¤çš„æ˜¯ä»¥æƒå€¼ä¸ºä¸‹æ ‡çš„ä¸€ä¸ªæ•°åˆ—ï¼ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¡¶ï¼‰çš„åŒºé—´ä¿¡æ¯ã€‚

### ç»ƒä¹ é¢˜

[Luogu P1486 [NOI2004]éƒé—·çš„å‡ºçº³å‘˜](https://www.luogu.com.cn/problem/P1486)

## æƒå€¼çº¿æ®µæ ‘ä¸Šçš„ã€ŒäºŒåˆ†ã€

å‡è®¾æˆ‘ä»¬éœ€è¦çŸ¥é“æƒå€¼çº¿æ®µæ ‘ä¸­ç¬¬ k ä¸ªå…ƒç´ æ˜¯ä»€ä¹ˆã€‚

åœ¨æŸ¥è¯¢æ—¶ï¼Œè‹¥æˆ‘ä»¬æ‰€æŸ¥çš„kå°äºç­‰äºå·¦å„¿å­çš„å’Œï¼Œåˆ™è¿›å…¥å·¦å„¿å­æŸ¥è¯¢ç¬¬kå¤§å€¼ã€‚

è‹¥kå¤§äºå·¦å„¿å­çš„å’Œï¼Œåˆ™è¿›å…¥å³å„¿å­æŸ¥è¯¢ç¬¬k - sum[l]å¤§å€¼ã€‚

```c++
int query(int k, int l, int r, int K) {
    if (l == r) return l;
    push_down(k, l, r);
    int mid = (l + r) >> 1;
    if (K <= sum[k << 1]) return query(k << 1, l, mid, K);
    else return query(k << 1 | 1, mid + 1, r, K - sum[k << 1]);
}
```

### æŸ¥è¯¢å…¨å±€ç¬¬ k å¤§

è¿™å…¶å®å¾ˆç›´è§‚ï¼Œæˆ‘ä»¬åªéœ€æŠŠæ•´ä¸ªæ•°åˆ—æ”¾è¿›æ¡¶é‡Œï¼Œåœ¨æŸ¥è¯¢æ—¶ä½¿ç”¨ä¸Šè¿°æ–¹æ³•å³å¯ã€‚

å¦‚æœä¸éœ€è¦æ”¯æŒä¿®æ”¹ï¼Œé‚£ä¹ˆç›´æ¥æ’åºå°±å¥½äº†ã€‚

å¦‚æœéœ€è¦æ”¯æŒåŒºé—´ä¿®æ”¹ï¼Œå¯ä»¥å†™æ ‘å¥—æ ‘ã€‚

### æŸ¥è¯¢åŒºé—´ç¬¬ k å¤§

æ˜¾ç„¶ï¼Œå¯¹äºåŒºé—´$[l, r]$çš„æŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ£µåŒºé—´$[l, r]$ä¸Šçš„æƒå€¼çº¿æ®µæ ‘ã€‚

å‡è®¾å¯¹äºå½“å‰è¯¢é—®ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºå¥½äº†ä¸€æ£µè¿™æ ·çš„æ ‘ï¼Œå¹¶è·å–äº†ç­”æ¡ˆã€‚

é‚£ä¹ˆï¼Œå¯¹äºä¸‹ä¸€ä¸ªè¯¢é—®$[l', r']$ï¼Œæˆ‘ä»¬éœ€è¦å°†å½“å‰å·¦å³ç«¯ç‚¹$l, r$ä¸€ä¸ªä¸ªæŒªåˆ°$l', r'$å»ï¼ŒåŒæ—¶è¿›è¡Œå•ç‚¹ä¿®æ”¹ã€‚

ä¸ºäº†ä½¿æŒªåŠ¨çš„æ“ä½œå°½å¯èƒ½å°‘ï¼Œæˆ‘ä»¬ä½¿ç”¨è«é˜Ÿç®—æ³•**ç¦»çº¿**å¤„ç†å„ä¸ªè¯¢é—®ã€‚

æ›´ç®€æ´çš„åšæ³•æ˜¯ä¸»å¸­æ ‘ï¼ˆå¯æŒä¹…åŒ–æƒå€¼çº¿æ®µæ ‘ï¼‰ã€‚

### ç»ƒä¹ é¢˜

[POJ 2985](http://poj.org/problem?id=2985)

## åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘

å¯ä»¥èŠ‚çœç©ºé—´ï¼Œæˆ–è€…åœ¨æ ‘å¥—æ ‘ã€ä¸»å¸­æ ‘ä¸­ä½¿ç”¨ã€‚

### ä¼ªåŠ¨æ€å¼€ç‚¹

å…ˆç”¨ä¸€ä¸ª`struct`æ¥è¡¨ç¤ºä¸€ä¸ªçº¿æ®µæ ‘èŠ‚ç‚¹ï¼Œå¹¶æå‰å¼€å¥½ä¸€ä¸ªå¤§å¤§çš„ buffer æ•°ç»„å’Œç”¨æ¥è®°å½•å·²åˆ†é…èŠ‚ç‚¹ä¸ªæ•°çš„`cnt`å˜é‡ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬ç”¨`lch`å’Œ`rch`è¡¨ç¤ºå·¦å³å­èŠ‚ç‚¹ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨æŒ‡é’ˆã€‚

```c++
struct node {
    int c, tag, lch, rch;
}buf[10000001];
int buf_cnt;
```

å¯¹äºéœ€è¦è®¿é—®çš„æ–°èŠ‚ç‚¹ï¼Œæˆ‘ä»¬è°ƒç”¨`new_node`å‡½æ•°è¿”å›å…¶åœ¨`buffer`æ•°ç»„ä¸­çš„ä¸‹æ ‡ã€‚

```c++
int new_node() {
    return ++buf_cnt;
}
```

### çœŸåŠ¨æ€å¼€ç‚¹

æ˜¾ç„¶ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æå‰å¼€å¥½äº†ä¸€ä¸ªå†…å­˜æ± ï¼ˆ`buffer`æ•°ç»„ï¼‰ï¼Œä»å†…å­˜æ± ä¸­åˆ†é…èŠ‚ç‚¹ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ C++ çš„`new`å’Œ`delete`æ¥åŠ¨æ€ç”³è¯·ã€é”€æ¯`node`ã€‚

æ³¨æ„ï¼Œæ­¤æ—¶ç”¨æ¥è¡¨ç¤ºå·¦å³å­èŠ‚ç‚¹çš„åªèƒ½æ˜¯æŒ‡é’ˆäº†ã€‚
